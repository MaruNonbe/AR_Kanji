<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>ARæ¼¢å­—ãƒ‰ãƒªãƒ«ï¼ˆãƒãƒ¼ã‚«ãƒ¼ç‰ˆï¼‰</title>

<!-- A-Frame + AR.js (marker-based) -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.4/aframe/build/aframe-ar.js"></script>

<!-- ä¸¸ã‚´ç³»ãƒ•ã‚©ãƒ³ãƒˆï¼ˆUIï¼‰ -->
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --ink:#e9edf5; --muted:#b7c6df; --panel:#0f1421; --line:#2a3550; --acc:#59c6ff;
  }
  html,body{margin:0;height:100%;background:#000;color:var(--ink);font-family:"Zen Maru Gothic","Noto Sans JP",system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
  a{color:#9fd1ff}

  /* ç”»é¢ä¸Šãƒ¡ãƒ¢ */
  .notice{position:fixed;left:8px;top:8px;background:rgba(0,0,0,.5);color:#cfe0ff;padding:6px 8px;border-radius:10px;font-size:12px;z-index:5}

  /* ä¸‹éƒ¨UI */
  .ui{
    position:fixed;left:0;right:0;bottom:0;display:flex;gap:8px;justify-content:center;
    padding:10px 10px calc(env(safe-area-inset-bottom,0) + 10px);
    background:linear-gradient(180deg,transparent,rgba(0,0,0,.55));z-index:6
  }
  .ui button{
    appearance:none;border:1px solid var(--line);background:#161b22;color:var(--ink);
    border-radius:12px;padding:10px 12px;font-size:14px
  }

  /* ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå¸¸æ™‚è¡¨ç¤ºï¼ˆãƒ•ãƒƒã‚¿ãƒ¼å³ä¸‹ï¼‰ */
  .credit{
    position:fixed;right:8px;bottom:calc(env(safe-area-inset-bottom,0) + 60px);
    color:var(--muted);font-size:11px;background:rgba(0,0,0,.40);
    padding:4px 6px;border-radius:8px;z-index:5
  }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç­†é †ï¼‰ */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:18px;z-index:10}
  .paper{background:var(--panel);border:1px solid var(--line);border-radius:14px;max-width:92ch;width:100%;max-height:85vh;overflow:auto;padding:16px}
  .paper h3{margin:0 0 8px}
  .close{float:right;border:1px solid var(--line);background:#161b22;color:var(--ink);border-radius:10px;padding:6px 10px}

  /* Chatï¼ˆç°¡æ˜“ä¼šè©±ï¼‰ */
  .chat{
    position:fixed; left:8px; right:8px; bottom:84px;
    background:rgba(15,20,33,.86); border:1px solid var(--line);
    border-radius:14px; backdrop-filter: blur(6px); color:var(--ink);
    max-width:720px; margin:0 auto; z-index:9;
  }
  .chat-head{display:flex;justify-content:space-between;align-items:center;
    padding:8px 12px; border-bottom:1px solid var(--line); font-size:14px}
  .chat-log{max-height:28vh; overflow:auto; padding:10px 12px; font-size:14px}
  .msg{display:flex; gap:8px; margin:6px 0}
  .msg .who{min-width:44px; opacity:.7}
  .msg .bubble{background:#121829; border:1px solid var(--line); border-radius:10px; padding:8px 10px; flex:1}
  .msg.me .bubble{background:#1c2437}
  .chat-input{display:flex; gap:8px; padding:8px; border-top:1px solid var(--line)}
  .chat-input input{flex:1; min-width:0; background:#0f1421; color:var(--ink); border:1px solid var(--line); border-radius:10px; padding:10px 12px}
  .chat-input button{appearance:none; border:1px solid var(--line); background:#161b22; color:var(--ink); border-radius:10px; padding:10px 12px}

  /* é–‹å§‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚«ãƒ¡ãƒ©/éŸ³ã®è¨±å¯ï¼‰ */
  .start{
    position:fixed; inset:0; display:grid; place-items:center; z-index:20;
    background:radial-gradient(1000px 600px at 50% -10%, #1b2440 0%, #070a12 60%, #000 100%);
    color:var(--ink);
  }
  .start .card{
    text-align:center; max-width:640px; padding:22px 18px; margin:0 16px;
    border:1px solid #263149; border-radius:16px; background:rgba(10,13,22,.65); backdrop-filter: blur(8px);
  }
  .logo{font-weight:700; font-size:22px; letter-spacing:.08em; margin-bottom:8px}
  .pulse{animation:pulse 1.8s infinite}
  @keyframes pulse{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
  .start button{
    margin-top:10px; appearance:none; border:1px solid var(--line); background:#1b2236; color:var(--ink);
    border-radius:12px; padding:12px 16px; font-size:16px
  }

  @media (max-width:480px){
    .chat{bottom:96px}
  }
</style>
</head>
<body>

<!-- ç”»é¢ä¸Šãƒ¡ãƒ¢ -->
<div class="notice">
  ãƒãƒ¼ã‚«ãƒ¼ï¼ˆHIROï¼‰ã«ã‹ã–ã—ã¦ãã ã•ã„ï¼š
  <a href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/three.js/examples/marker-training/examples/pattern-files/hiro.png" target="_blank">å°åˆ·ç”¨HIRO</a>
</div>

<!-- A-Frameã‚·ãƒ¼ãƒ³ï¼šã‚«ãƒ¡ãƒ©è¨±å¯ãŒå¿…è¦ -->
<a-scene embedded vr-mode-ui="enabled:false" renderer="alpha:true;antialias:true"
         arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false">
  <!-- HIROãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸã‚‰ä¸­èº«ã‚’è¡¨ç¤º -->
  <a-marker type="pattern" url="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/three.js/examples/marker-training/examples/pattern-files/patt.hiro">
    <!-- æ¼¢å­—è¡¨ç¤ºï¼ˆå¤§ããª3Dãƒ†ã‚­ã‚¹ãƒˆï¼‰ -->
    <a-entity id="kanjiText" text="value: æµ·; color: #59c6ff; align: center; width: 4"
              position="0 0 0" rotation="-90 0 0"></a-entity>
    <!-- ãƒ™ãƒ¼ã‚¹ï¼ˆå½±é˜²æ­¢ã®ãŸã‚å¹³é¢ï¼‰ -->
    <a-plane position="0 -0.01 0" rotation="-90 0 0" width="2" height="2" color="#111" opacity="0.4"></a-plane>
  </a-marker>

  <!-- ARç”¨ã‚«ãƒ¡ãƒ© -->
  <a-entity camera></a-entity>
</a-scene>

<!-- ä¸‹éƒ¨UIï¼ˆéŸ³å£°ãƒ»ç­†é †ãƒ»åˆ‡æ›¿ï¼‰ -->
<div class="ui" aria-label="æ“ä½œãƒ‘ãƒãƒ«">
  <button id="btnSpeak">éŸ³å£°</button>
  <button id="btnStroke">ç­†é †ã‚¢ãƒ‹ãƒ¡</button>
  <button id="btnNext">æ¬¡ã®å•é¡Œ</button>
</div>

<!-- ãƒ•ãƒƒã‚¿ãƒ¼ãƒ»ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆï¼ˆå¸¸æ™‚è¡¨ç¤º & å°åˆ·æ™‚ã¯è‡ªå‹•è„šæ³¨ï¼‰ -->
<div class="credit" id="credit">
  Â© Freedom ï½œ Uses KanjiVG (CC BY-SA 3.0) ï½œ For non-commercial educational use
</div>

<!-- ç­†é †ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="strokeModal" class="modal" role="dialog" aria-modal="true">
  <div class="paper">
    <button id="closeStroke" class="close">é–‰ã˜ã‚‹</button>
    <h3>ç­†é †ã‚¢ãƒ‹ãƒ¡</h3>
    <div id="strokeBox" style="min-height:220px"></div>
    <p style="font-size:12px;color:var(--muted)">ãƒ‡ãƒ¼ã‚¿ï¼šKanjiVGï¼ˆCC BY-SA 3.0ï¼‰ã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã¯CDNã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã¯ã“ã®HTMLã¨åŒéšå±¤ã® <code>/kanjivg/</code> ã‚’å‚ç…§ã—ã¾ã™ã€‚</p>
  </div>
</div>

<!-- Chatï¼ˆç°¡æ˜“ä¼šè©±ï¼‰ -->
<div class="chat" aria-live="polite">
  <div class="chat-head">
    <strong>ã‚¢ãƒ—ãƒªã¨ä¼šè©±</strong>
    <label style="display:flex;gap:6px;align-items:center;font-size:12px">
      <input id="chatTTS" type="checkbox"> è¿”ä¿¡ã‚’èª­ã¿ä¸Šã’
    </label>
  </div>
  <div id="chatLog" class="chat-log"></div>
  <div class="chat-input">
    <input id="chatText" type="text" placeholder="ä¾‹ï¼‰ç­†é †è¦‹ã›ã¦ / æ¬¡ / å§¿å‹¢ / ã»ã‚ã¦ / ãƒ’ãƒ³ãƒˆ" autocomplete="off">
    <button id="chatSend">é€ä¿¡</button>
  </div>
</div>

<!-- é–‹å§‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§BGM & ã‚«ãƒ¡ãƒ©å®Ÿè¡Œï¼‰ -->
<div class="start" id="start">
  <div class="card">
    <div class="logo">ARæ¼¢å­—ãƒ‰ãƒªãƒ«</div>
    <div>ã€Œé–‹å§‹ã€ã‚’æŠ¼ã—ã¦ã€ã‚«ãƒ¡ãƒ©åˆ©ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚BGMã¯ã„ã¤ã§ã‚‚åœæ­¢ã§ãã¾ã™ã€‚</div>
    <button id="btnStart" class="pulse">é–‹å§‹</button>
    <div style="margin-top:10px;font-size:12px;color:var(--muted)">
      æ¨å¥¨ï¼šæ˜ã‚‹ã„å ´æ‰€ï¼HIROãƒãƒ¼ã‚«ãƒ¼ã‚’å°åˆ·ã—ã¦æ°´å¹³ã«ç½®ã
    </div>
  </div>
</div>

<!-- ä»»æ„BGMï¼ˆå·®ã—æ›¿ãˆãŸã„å ´åˆã¯ src ã‚’è‡ªå‰ã®CC0éŸ³æºã«å¤‰æ›´ï¼‰ -->
<audio id="bgm" loop preload="none" crossorigin="anonymous"></audio>

<script>
/* =========================
   åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
   å®Ÿé‹ç”¨ã§ã¯CSVç­‰ã«å·®ã—æ›¿ãˆå¯
========================= */
const items = [
  {kana:'ã†ã¿',kanji:'æµ·',sentence:'ã†ã¿ã§ãŠã‚ˆã'},
  {kana:'ã‚„ã¾',kanji:'å±±',sentence:'ã‚„ã¾ã§ãƒã‚¤ã‚­ãƒ³ã‚°ã‚’ã™ã‚‹'},
  {kana:'ã‹ã‚',kanji:'å·',sentence:'ã‹ã‚ã§çŸ³ã‚’ã²ã‚ã†'},
  {kana:'ãªãŒ',kanji:'é•·',sentence:'ãªãŒã„é“'}
];
let idx = 0;

/* =========================
   ARã®ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
========================= */
const kanjiEntity = document.getElementById('kanjiText');
function renderAR() {
  const it = items[idx];
  kanjiEntity.setAttribute('text', `value: ${it.kanji}; color: #59c6ff; align: center; width: 4`);
}

/* =========================
   éŸ³å£°èª­ã¿ä¸Šã’ï¼ˆWeb Speechï¼‰
========================= */
function speak(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'ja-JP'; u.rate = 1.0; u.pitch = 1.0;
    window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
  }catch(e){}
}
document.getElementById('btnSpeak').addEventListener('click', ()=>{
  const it = items[idx];
  speak(`${it.kana}ã€‚${it.sentence}`);
});

/* =========================
   ç­†é †ï¼ˆKanjiVGï¼šCDNâ†’ãƒ­ãƒ¼ã‚«ãƒ«/kanjivgï¼‰
========================= */
function kanjivgUrls(ch){
  const cp = ch.codePointAt(0);
  const f5 = cp.toString(16).padStart(5,'0');
  const f4 = cp.toString(16).padStart(4,'0');
  return [
    `https://cdn.jsdelivr.net/gh/KanjiVG/kanjivg/kanji/${f5}.svg`,
    `./kanjivg/${f5}.svg`,
    `./kanjivg/${f4}.svg`,
  ];
}
async function showStrokeOrder(ch){
  const box = document.getElementById('strokeBox');
  box.innerHTML = '<div style="color:#9fb4ff">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
  let svgText=null;
  for(const u of kanjivgUrls(ch)){
    try{ const res = await fetch(u, {mode:'cors'}); if(res.ok){ svgText = await res.text(); break; } }catch(_){}
  }
  if(!svgText){ box.innerHTML = 'ç­†é †ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'; return; }
  const wrap = document.createElement('div'); wrap.innerHTML = svgText;
  const svg = wrap.querySelector('svg'); if(!svg){ box.textContent='ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼'; return; }
  svg.setAttribute('width','320'); svg.setAttribute('height','320'); svg.setAttribute('viewBox','0 0 109 109');
  svg.querySelectorAll('path').forEach(p=>{
    p.setAttribute('fill','none'); p.setAttribute('stroke','#7fb3ff'); p.setAttribute('stroke-width','4');
    p.setAttribute('stroke-linecap','round'); p.setAttribute('stroke-linejoin','round');
  });
  box.innerHTML=''; box.appendChild(svg);
  const paths=[...svg.querySelectorAll('path')].filter(p=>!(p.getAttribute('id')||'').startsWith('kvg:StrokeNumbers'));
  let i=0; (function step(){ if(i>=paths.length) return;
    const p=paths[i++]; const len=p.getTotalLength();
    p.style.strokeDasharray=len; p.style.strokeDashoffset=len; void p.getBoundingClientRect();
    p.style.transition='stroke-dashoffset 600ms ease'; p.style.strokeDashoffset='0';
    setTimeout(step,650);
  })();
}
const modal = document.getElementById('strokeModal');
document.getElementById('btnStroke').addEventListener('click', ()=>{
  modal.style.display='flex'; showStrokeOrder(items[idx].kanji);
});
document.getElementById('closeStroke').addEventListener('click', ()=> modal.style.display='none');
document.getElementById('strokeModal').addEventListener('click', (e)=>{ if(e.target.id==='strokeModal') modal.style.display='none' });

/* =========================
   æ¬¡ã®å•é¡Œ
========================= */
document.getElementById('btnNext').addEventListener('click', ()=>{
  idx = (idx+1) % items.length; renderAR();
});

/* =========================
   Chatï¼ˆç°¡æ˜“ä¼šè©±ï¼‰
========================= */
const chatLog = document.getElementById('chatLog');
const chatText = document.getElementById('chatText');
const chatSend = document.getElementById('chatSend');
const chatTTS  = document.getElementById('chatTTS');

function pushMsg(who, text){
  const div = document.createElement('div');
  div.className = 'msg' + (who==='ã‚ãŸã—' ? ' me' : '');
  div.innerHTML = `<div class="who">${who}</div><div class="bubble">${text}</div>`;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}
function reply(text){
  pushMsg('ã‚¢ãƒ—ãƒª', text);
  if(chatTTS?.checked){ try{ speak(text); }catch(_){} }
}
function handleUserQuery(q){
  const it = items[idx];
  const s = q.trim().replace(/\s+/g,'').toLowerCase();

  if(/^(ã¤ã|æ¬¡|next)$/.test(s)){ idx = (idx+1)%items.length; renderAR(); return reply('ã¤ãã®å•é¡Œã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚'); }
  if(/^(ã¾ãˆ|å‰|prev|ã‚‚ã©ã—ã¦|æˆ»ã—ã¦)$/.test(s)){ idx = (idx-1+items.length)%items.length; renderAR(); return reply('å‰ã®å•é¡Œã«æˆ»ã—ã¾ã—ãŸã€‚'); }
  if(/(ç­†é †|ã²ã¤ã˜ã‚…ã‚“|stroke)/.test(s)){ showStrokeOrder(it.kanji); modal.style.display='flex'; return reply(`ã€Œ${it.kanji}ã€ã®ç­†é †ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚`); }
  if(/(ã‚ˆã‚“ã§|èª­ã‚“ã§|éŸ³å£°|ãŠã‚“ã›ã„|ã—ã‚ƒã¹ã£ã¦)/.test(s)){ try{ speak(`${it.kana}ã€‚${it.sentence}`); }catch(_){}
    return reply('èª­ã¿ä¸Šã’ã¾ã—ãŸã€‚'); }
  if(/(ãƒ’ãƒ³ãƒˆ|hint)/.test(s)){ return reply(`ãƒ’ãƒ³ãƒˆï¼šæœ€åˆã®æ–‡å­—ã¯ã€Œ${it.kanji[0]}ã€ã€‚ç©ºã§å¤§ããæ›¸ã„ã¦ã¿ã‚ˆã†ã€‚`); }
  if(/(æ„å‘³|ã„ã¿|ã©ã‚“ãªæ¼¢å­—)/.test(s)){ return reply(`ä»Šã®æ¼¢å­—ã¯ã€Œ${it.kanji}ã€ã§ã€èª­ã¿ã¯ã€Œ${it.kana}ã€ã€‚ä¾‹æ–‡ï¼š${it.sentence}`); }
  if(/(å§¿å‹¢|ã—ã›ã„|æŒã¡æ–¹|ã‚‚ã¡ã‹ãŸ)/.test(s)){
    const tips = [
      'ç´™ã¯å°‘ã—æ–œã‚ã«ã€‚å·¦æ‰‹ã§ç´™ã‚’æŠ¼ã•ãˆã‚ˆã†ã€‚',
      'è‚˜ã‚’æœºã«è»½ãç½®ã„ã¦ã€æ‰‹é¦–ã‚’ãµã‚ã£ã¨ã€‚',
      'æ›¸ãå‰ã«æ·±å‘¼å¸ã‚’3ç§’ã€‚ã‚†ã£ãã‚Šã§OKã€‚',
      'ä¸€ç”»ã”ã¨ã«æ­¢ã‚ãƒ»ã¯ã­ãƒ»ã¯ã‚‰ã„ã‚’æ„è­˜ã€‚'
    ];
    return reply(tips[Math.floor(Math.random()*tips.length)]);
  }
  if(/(ã»ã‚ã¦|è¤’ã‚ã¦|ã¤ã‹ã‚ŒãŸ|ç–²ã‚ŒãŸ|ã‚€ãšã‹ã—ã„|é›£ã—ã„)/.test(s)){
    const cheers = [
      'ã„ã„ãƒšãƒ¼ã‚¹ï¼æ˜¨æ—¥ã‚ˆã‚Šä¸€æ­©å‰é€²ã—ã¦ã‚‹ã‚ˆğŸ‘',
      'å¤§ä¸ˆå¤«ã€‚1åˆ†ä¼‘ã‚“ã§ã‹ã‚‰ã€æœ€åˆã®ä¸€ç”»ã ã‘ä¸€ç·’ã«ã„ã“ã†ã€‚',
      'ã§ãã¦ã‚‹ï¼ç·šãŒã¾ã£ã™ãã§èª­ã¿ã‚„ã™ã„ã­ã€‚',
      'ã‚†ã£ãã‚Šã§OKã€‚å¤±æ•—ã¯å­¦ã³ã®è¿‘é“ã ã‚ˆã€‚'
    ];
    return reply(cheers[Math.floor(Math.random()*cheers.length)]);
  }
  if(/(ã“ã‚“ã«ã¡ã¯|ã“ã‚“ã°ã‚“ã¯|ã‚„ã‚|hello|hi)/.test(s)){
    return reply('ã“ã‚“ã«ã¡ã¯ï¼ã€Œç­†é †ã€ã€Œæ¬¡ã€ã€Œå§¿å‹¢ã€ã€Œãƒ’ãƒ³ãƒˆã€ã€Œã»ã‚ã¦ã€ãªã©è©±ã—ã‹ã‘ã¦ã­ã€‚');
  }
  return reply('ã‚ã‹ã‚‰ãªã‹ã£ãŸâ€¦ ä¾‹ï¼šã€ç­†é †ã€ã€éŸ³å£°ã€ã€æ¬¡ã€ã€å§¿å‹¢ã€ã€ãƒ’ãƒ³ãƒˆã€ã€ã»ã‚ã¦ã€ã‚’è©¦ã—ã¦ã­ã€‚');
}
function sendChat(){
  const text = chatText.value.trim();
  if(!text) return;
  pushMsg('ã‚ãŸã—', text);
  chatText.value = '';
  handleUserQuery(text);
}
chatSend.addEventListener('click', sendChat);
chatText.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendChat(); });

/* =========================
   BGMï¼ˆè‡ªå‹•ç”Ÿæˆ or ä»»æ„éŸ³æºï¼‰ï¼†é–‹å§‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
========================= */
const start = document.getElementById('start');
const btnStart = document.getElementById('btnStart');
const bgm = document.getElementById('bgm');

let audioCtx, gOsc = [];
function startWebAudioAmbient(){
  try{
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const master = audioCtx.createGain(); master.gain.value = 0.06; master.connect(audioCtx.destination);
    // å’ŒéŸ³ã£ã½ã„ãƒ‘ãƒƒãƒ‰ï¼ˆè‘—ä½œæ¨©ãƒ•ãƒªãƒ¼ï¼šç”ŸæˆéŸ³ï¼‰
    [220, 277.18, 329.63].forEach((f,i)=>{
      const osc = audioCtx.createOscillator();
      const g = audioCtx.createGain(); g.gain.value = 0.0;
      osc.type = 'sine'; osc.frequency.value = f;
      osc.connect(g); g.connect(master);
      osc.start();
      // ã‚†ã£ãã‚Šãƒ•ã‚§ãƒ¼ãƒ‰
      const t = audioCtx.currentTime + i*0.2;
      g.gain.linearRampToValueAtTime(0.0, t);
      g.gain.linearRampToValueAtTime(0.12, t+4.0);
      g.gain.linearRampToValueAtTime(0.08, t+8.0);
      gOsc.push({osc,g});
    });
  }catch(e){}
}
btnStart.addEventListener('click', async ()=>{
  // iOS/Android ã®ã‚ªãƒ¼ãƒˆå†ç”Ÿåˆ¶é™å›é¿ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§é–‹å§‹
  try{
    // è‡ªå‰éŸ³æºã‚’ä½¿ã„ãŸã„å ´åˆï¼šbgm.src = 'YOUR_CC0_MUSIC.mp3';
    if(bgm.src){ await bgm.play(); } else { startWebAudioAmbient(); }
  }catch(_){}
  start.style.display = 'none';
  renderAR();
});

/* =========================
   å°åˆ·æ™‚ã«è„šæ³¨ã‚’è‡ªå‹•æŒ¿å…¥
========================= */
(function ensurePrintFootnote(){
  const style = document.createElement('style');
  style.media = 'print';
  style.textContent = `
  @page{ margin: 16mm }
  #credit{ position: static; background: none; padding: 0; font-size: 10pt }
  .ui, .chat, .notice, .start { display:none !important }
  `;
  document.head.appendChild(style);
})();

/* åˆæœŸè¡¨ç¤ºï¼ˆARãƒ†ã‚­ã‚¹ãƒˆã¯é–‹å§‹ã‚¯ãƒªãƒƒã‚¯å¾Œã«åæ˜ ï¼‰ */
renderAR();
</script>
</body>
</html>
